#!/usr/bin/env node

var prompt   = require ('prompt')
  , winston  = require ('winston')
  ;

var Account = require ('../app/models/Account')
  , db      = require ('../lib/db')
  , config  = require ('../configs').get ()
  ;

var options = {
  message : 'gatekeeper'
};

var schema = {
  properties : {
    username : {
      pattern     : /^[a-zA-Z0-9\s\-\s\_]+$/,
      message     : 'Username can only contain alphanumerics, dashes, and underscores',
      required    : true,
      type        : 'string'
    },
    password : {
      required : true,
      hidden   : true
    },
    email : {
      required : true
    }
  }
};

prompt.start (options);

prompt.get (schema, function (err, result) {
  if (err)
    return winston.error (err);

  // Connect to the database
  db.connect (config.connstr, config.mongodb, function (err) {
    if (err)
      return winston.error (err);

    var account = new Account ({
      username : result.username,
      password : result.password,
      email : result.email,
      roles : ['admin']
    });

    winston.info ('saving ' + result.username + ' to the database')
    account.save (function (err) {
      if (err)
        winston.error (err);

      winston.info ('successfully saved ' + result.username + ' to the database')
      db.close ();
    });
  });
});
