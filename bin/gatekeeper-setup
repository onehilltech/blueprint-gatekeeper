#!/usr/bin/env node

const winston = require ('winston')
  , prompt    = require ('prompt')
  , blueprint = require ('@onehilltech/blueprint')
  , path      = require ('path')
  , async     = require ('async')
  , fse       = require ('fs-extra')
  ;

let appPath = path.resolve (process.cwd (), 'app');
let rcPath  = path.resolve (process.cwd (), '.gatekeeper');

const DEFAULT_SCOPE = ['gatekeeper.account.*', 'gatekeeper.client.*'];

async.waterfall ([
  function (callback) { prompt.get (['email'], callback); },
  execute
], setupComplete);

function execute (args, callback) {
  async.waterfall ([
    function (callback) {
      blueprint.createApplicationAndStart (appPath, callback);
    },

    function (app, callback) {
      fse.ensureDir (rcPath, function (err) {
        return callback (err, app);
      });
    },

    function (exists, callback) {
      let data = [
        {type: 'native', name: 'gatekeeper-cli', email: args.email, scope: DEFAULT_SCOPE}
      ];

      const Client = blueprint.app.models.Client;
      Client.create (data, callback);
    },

    function (clients, callback) {
      async.each (clients, function (client, callback) {
        let data = {
          client_id: client.id,
          client_secret: client.client_secret
        };

        let filename = path.resolve (rcPath, client.name);
        fse.writeJSON (filename, data, {spaces: 2}, callback);
      }, callback);
    }], callback);
}

function setupComplete (err) {
  if (err)
    throw err;

  winston.log ('info', 'setup complete!');
  process.exit (0);
}
