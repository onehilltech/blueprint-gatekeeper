#!/usr/bin/env node
'use strict';

var winston   = require ('winston')
  , prompt    = require ('prompt')
  , blueprint = require ('@onehilltech/blueprint')
  , path      = require ('path')
  , async     = require ('async')
  , jsonfile  = require ('jsonfile')
  , fs        = require ('fs')
  , roles     = require ('../lib').roles
  ;

var appPath = path.resolve (process.cwd (), 'app');
var rcPath  = path.resolve (appPath, 'resources/gatekeeper');

  async.waterfall ([
  function (callback) {
    blueprint.Application (appPath, callback);
  },

  function (app, callback) {
    app.database.connect (function (err) {
      return callback (err, app);
    });
  },

  function (app, callback) {
    fs.stat (rcPath, function (err) {
      if (err)
        return fs.mkdir (rcPath, function (err) {
          return callback (err, app);
        });

      return callback (null, app);
    });
  },

  function (app, callback) {
    prompt.start ();
    prompt.get (['email'], function (err, result) {
      return callback (err, app, result);
    });
  },

  function (app, result, callback) {
    var data = [
      {name: 'gatekeeper-cli', email: result.email, roles: [roles.client.account.create]},
      {name: 'gatekeeper-webportal', email: result.email, roles: [roles.client.account.create]}
    ];

    async.waterfall ([
      function (callback) { app.models.Client.create (data, callback); },
      function (clients, callback) {
        async.each (clients, function (client, callback) {
          var data = {
            client_id: client.id,
            client_secret: client.secret
          };

          var dataFile = path.resolve (rcPath, client.name);
          jsonfile.writeFile (dataFile, data, {spaces: 2}, callback);
        }, callback);
      }
    ], function (err) {
      return callback (err, app);
    });
  }
], function (err) {
  if (err) throw err;
  process.exit (0);
});
