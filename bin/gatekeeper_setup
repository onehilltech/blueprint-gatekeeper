#!/usr/bin/env node

var winston  = require ('winston')
  , argv     = require ('yargs').argv
  ;

var Client  = require ('../lib/models/oauth2/client')
  , db      = require ('../lib/db')
  , config  = require ('../config')
  ;

const DEFAULT_CLIENT_NAME = "Gatekeeper Webapp";
const DEFAULT_EMAIL = "contact@gatekeeper.com";
const DEFAULT_REDIRECT_URI = 'https://localhost/admin/callback';

function setupComplete (err) {
  // Close our connection to the database.
  db.close ();

  if (err)
    return winston.error (err);
  else
    winston.info ('setup is complete!');
}


function performSetup (done) {
  winston.info ('performing initial setup');

  // Connect to the database
  var currConfig = config.get ();
  db.connect (currConfig.connstr, currConfig.mongodb, function (err) {
    if (err)
      return done (err);

    // Create the client id and secret for the admin service.
    winston.info  ('registering gatekeeper web application client');

    function completed (err, client) {
      if (err)
        return done(err);

      // Update the configuration file.
      winston.info ('updating configuration with OAuth 2.0 information');
      config.set ('oauth2:client_id', client.id);
      config.set ('oauth2:client_secret', client.secret);
      config.save (done);
    }

    if (argv.force) {
      winston.warn ('updating existing client; previous credentials will be invalidated');
      Client.upsertClient (DEFAULT_CLIENT_NAME, DEFAULT_EMAIL, DEFAULT_REDIRECT_URI, completed);
    }
    else {
      winston.info ('registering new client');
      Client.registerNewClient (DEFAULT_CLIENT_NAME, DEFAULT_EMAIL, DEFAULT_REDIRECT_URI, completed);
    }
  });
}

// Execute the setup process.
performSetup (setupComplete);
