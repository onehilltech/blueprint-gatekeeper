#!/usr/bin/env node

var nconf      = require ('nconf')
  , winston    = require ('winston')
  , path       = require ('path')
  , express    = require ('express')
  , validation = require ('express-validator')
  , bodyParser = require ('body-parser')
  , mongoose   = require ('mongoose')
  ;

var AdminRouter = require ('../lib/router/admin')
  ;

// Load the node configuration.
var env = process.env.NODE_ENV || 'dev';
winston.info ('execution environment: ' + env);

var config_file = path.join (__dirname, '../config', env + '.json');
nconf.env ().file ({file: config_file}).argv ();
var config = nconf.get ();

// Create a new server, and start it.
var app = express ();

// Set the template engine for the service.
app.set ('views', path.join (__dirname, '../views'));
app.set ('view engine', 'jade');

app.use (bodyParser.urlencoded ({ extended: false }));
app.use (bodyParser.json ());
app.use (validation ());

// Define the dynamic routes.
app.use ('/', new AdminRouter ().makeRouter ());

// Define the static routes.
app.use (express.static (path.join (__dirname, '../public_html')));

mongoose.connect (config.connstr, config.mongodb, function (err) {
  if (err)
    return err;

  app.listen (config.port, function (err) {
    if (!err)
      winston.log ('info', 'listening on port', config.port);
  });
});
